// Debug function for manual mode
function debugLog(message) {
    console.log('DEBUG:', message);
    const debugOutput = document.getElementById('debug-output');
    if (debugOutput) {
        debugOutput.innerHTML = new Date().toLocaleTimeString() + ': ' + message + '<br>' + debugOutput.innerHTML;
    }
}

function setManualErrors() {
    const errors = {};
    let activeCount = 0;
    const selectedErrors = [];

    for (let i = 1; i <= 7; i++) {
        const element = document.getElementById('stromkreis' + i);
        if (element) {
            const val = element.value;
            if (val !== '') {
                const relayId = parseInt(val);
                if (!isNaN(relayId)) {
                    errors['stromkreis' + i] = relayId;
                    activeCount++;
                    const selectedOption = element.options[element.selectedIndex];
                    selectedErrors.push(`Stromkreis ${i}: ${selectedOption.text} (Relais ${relayId})`);
                }
            }
        }
    }

    if (activeCount === 0) {
        alert('âš  Keine Fehler ausgewÃ¤hlt!');
        return;
    }

    // Kein Confirm mehr!
    const requestBody = JSON.stringify({errors: errors});

    fetch('/set_manual_errors', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: requestBody
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… ${data.activated_count} Fehler erfolgreich zugeschaltet!\nAktive Relais: ${data.active_relays.join(', ')}`);
            updateStatusDisplay();
        } else {
            alert(`âŒ Fehler beim Zuschalten: ${data.error || 'Unbekannter Fehler'}`);
        }
    })
    .catch(error => {
        alert('ðŸš« Verbindungsfehler: ' + error);
    });
}

function resetRelays() {
    if (!confirm('ðŸ”„ Alle Relais zurÃ¼cksetzen?\n\nDies deaktiviert alle aktiven Fehler.')) {
        return;
    }
    
    fetch('/reset_relays', {method: 'POST'})
    .then(resp => resp.json())
    .then(data => {
        for (let i = 1; i <= 7; i++) {
            const selectElement = document.getElementById('stromkreis' + i);
            const descriptionDiv = document.getElementById('description' + i);
            if (selectElement) selectElement.value = '';
            if (descriptionDiv) descriptionDiv.innerHTML = '<em>Kein Fehler ausgewÃ¤hlt</em>';
        }
        updateStatusDisplay();
        alert('âœ… Alle Relais zurÃ¼ckgesetzt!');
    })
    .catch(error => {
        alert('ðŸš« Verbindungsfehler beim Reset!');
    });
}

function updateStatusDisplay() {
    const statusText = document.getElementById('status-text');
    const activeErrors = [];
    for (let i = 1; i <= 7; i++) {
        const selectEl = document.getElementById('stromkreis' + i);
        if (selectEl && selectEl.value !== '') {
            const relayId = parseInt(selectEl.value);
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const errorName = selectedOption.text.split(' (')[0];
            activeErrors.push(`Stromkreis ${i}: ${errorName} (Relais ${relayId})`);
        }
    }
    if (activeErrors.length === 0) {
        statusText.textContent = 'Keine Fehler aktiv';
        statusText.style.color = '#4CAF50';
    } else {
        statusText.innerHTML = `<strong>${activeErrors.length} Fehler ausgewÃ¤hlt:</strong><br>â€¢ ` + activeErrors.join('<br>â€¢ ');
        statusText.style.color = '#ff9800';
    }
}

// Reset-Funktion (optional ausgelagert)
function resetRelays() {
    if (!confirm('ðŸ”„ Alle Relais zurÃ¼cksetzen?\n\nDies deaktiviert alle aktiven Fehler.')) {
        return;
    }
    
    debugLog('Resetting relays...');
    
    fetch('/reset_relays', {method: 'POST'})
    .then(resp => resp.json())
    .then(data => {
        debugLog('Reset response: ' + JSON.stringify(data));
        for (let i = 1; i <= 7; i++) {
            const selectElement = document.getElementById('stromkreis' + i);
            const descriptionDiv = document.getElementById('description' + i);
            if (selectElement) selectElement.value = '';
            if (descriptionDiv) descriptionDiv.innerHTML = '<em>Kein Fehler ausgewÃ¤hlt</em>';
        }
        updateStatusDisplay();
        alert('âœ… Alle Relais zurÃ¼ckgesetzt!');
    })
    .catch(error => {
        debugLog('Reset error: ' + error);
        alert('ðŸš« Verbindungsfehler beim Reset!');
    });
}

// Statusanzeige aktualisieren
function updateStatusDisplay() {
    const statusText = document.getElementById('status-text');
    const activeErrors = [];
    for (let i = 1; i <= 7; i++) {
        const selectEl = document.getElementById('stromkreis' + i);
        if (selectEl && selectEl.value !== '') {
            const relayId = parseInt(selectEl.value);
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const errorName = selectedOption.text.split(' (')[0];
            activeErrors.push(`Stromkreis ${i}: ${errorName} (Relais ${relayId})`);
        }
    }
    if (activeErrors.length === 0) {
        statusText.textContent = 'Keine Fehler aktiv';
        statusText.style.color = '#4CAF50';
    } else {
        statusText.innerHTML = `<strong>${activeErrors.length} Fehler ausgewÃ¤hlt:</strong><br>â€¢ ` + activeErrors.join('<br>â€¢ ');
        statusText.style.color = '#ff9800';
    }
}
function startExam(examNumber) {
    fetch('/start_exam', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
        body: JSON.stringify({exam_number: examNumber})
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            // Timer anzeigen, Start-Button ausblenden, Fertig-Button einblenden
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'inline-block';
            document.getElementById('timerDisplay').style.display = 'block';
            // Optional: Fehler anzeigen
            alert('âœ… PrÃ¼fung gestartet!\nFehler: ' + data.error_details.map(e => e.name).join(', '));
            startTimer();
        } else {
            alert('âŒ Fehler beim Start: ' + (data.error || 'Unbekannt'));
        }
    })
    .catch(err => {
        alert('ðŸš« Verbindungsfehler: ' + err);
    });
}

// Timer fÃ¼r PrÃ¼fungsmodus
let timerSeconds = 20 * 60;
let timerInterval;
function startTimer() {
    timerSeconds = 20 * 60;
    updateTimerDisplay();
    timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();
        if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            finishExam();
        }
    }, 1000);
}
function updateTimerDisplay() {
    const min = Math.floor(timerSeconds / 60);
    const sec = timerSeconds % 60;
    document.getElementById('timer').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
}

function finishExam() {
    // Stoppe Timer
    if (timerInterval) clearInterval(timerInterval);
    document.getElementById('finishBtn').style.display = 'none';
    document.getElementById('timerDisplay').style.display = 'none';
    // Hole PrÃ¼fungsnummer aus HTML
    const examNumber = document.querySelector('.exam-number').textContent.replace('PrÃ¼fungsnummer:','').trim();
    const duration = 20 * 60 - timerSeconds;
    fetch('/finish_exam', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
        body: JSON.stringify({exam_number: examNumber, duration: duration})
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert('âœ… PrÃ¼fung beendet!');
            document.getElementById('startBtn').style.display = 'inline-block';
        } else {
            alert('âŒ Fehler beim Beenden: ' + (data.error || 'Unbekannt'));
        }
    })
    .catch(err => {
        alert('ðŸš« Verbindungsfehler: ' + err);
    });
}

function runTest() {
    fetch('/run_test', {method: 'POST'})
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            alert('âœ… Test erfolgreich durchgefÃ¼hrt!');
        } else {
            alert('âŒ Test fehlgeschlagen: ' + (data.error || 'Unbekannt'));
        }
    })
    .catch(err => {
        alert('ðŸš« Verbindungsfehler: ' + err);
    });
}
// Optional: showCurrentSelections und testConnection kÃ¶nnen auch ausgelagert werden, falls benÃ¶tigt.
// Die Event-Listener fÃ¼r Select-Felder und DOMContentLoaded sollten weiterhin im Template bleiben (oder hier ergÃ¤nzt werden, wenn ausgelagert).
