{% extends "base.html" %}
{% block title %}Einstellungen - VDE Messwand{% endblock %}
{% block content %}
<div class="glass-card">
    <h1>‚öôÔ∏è Admin-Einstellungen</h1>
    <p style="text-align: center; opacity: 0.8; margin-bottom: 30px;">
        Systemeinstellungen verwalten
    </p>

    <div id="messageBox" class="message"></div>

    <!-- Admin-Code √§ndern -->
    <div class="settings-section">
        <h2 class="section-title">üîí Admin-Code √§ndern</h2>
        <p class="section-description">
            Aktueller Code: <span class="current-code">{{ current_code }}</span>
        </p>

        <form id="codeForm">
            <div class="form-group">
                <label for="currentCode">Aktueller Code</label>
                <input type="password"
                       id="currentCode"
                       class="form-control"
                       placeholder="Aktuellen Code eingeben"
                       required>
            </div>

            <div class="form-group">
                <label for="newCode">Neuer Code (4-20 Ziffern)</label>
                <input type="password"
                       id="newCode"
                       class="form-control"
                       placeholder="Neuen Code eingeben"
                       pattern="[0-9]{4,20}"
                       required>
                <small style="color: rgba(255, 255, 255, 0.6);">
                    Der Code muss aus 4-20 Ziffern bestehen
                </small>
            </div>

            <div class="form-group">
                <label for="confirmCode">Neuen Code best√§tigen</label>
                <input type="password"
                       id="confirmCode"
                       class="form-control"
                       placeholder="Neuen Code wiederholen"
                       required>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn">üíæ Code √§ndern</button>
                <button type="button" class="btn btn-secondary" onclick="showCode()">
                    üëÅÔ∏è Code anzeigen
                </button>
            </div>
        </form>
    </div>

    <!-- Weitere Einstellungen k√∂nnen hier hinzugef√ºgt werden -->
</div>

<style>
.settings-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.section-title {
    font-size: 1.5em;
    color: #ff4444;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(255, 68, 68, 0.3);
}

.section-description {
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 20px;
    line-height: 1.6;
}

.current-code {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #ff4444;
    background: rgba(255, 68, 68, 0.1);
    padding: 5px 15px;
    border-radius: 8px;
    border: 1px solid rgba(255, 68, 68, 0.3);
    filter: blur(5px);
    transition: filter 0.3s;
}

.current-code:hover {
    filter: blur(0);
}

.message {
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
    display: none;
    font-weight: 600;
}

.message.success {
    background: rgba(40, 167, 69, 0.2);
    border: 2px solid rgba(40, 167, 69, 0.4);
    color: #28a745;
    display: block;
}

.message.error {
    background: rgba(220, 53, 69, 0.2);
    border: 2px solid rgba(220, 53, 69, 0.4);
    color: #dc3545;
    display: block;
}

@media (max-width: 768px) {
    .settings-section {
        padding: 15px;
    }
}
</style>

<script>
function showMessage(message, type) {
    const msgBox = document.getElementById('messageBox');
    msgBox.textContent = message;
    msgBox.className = `message ${type}`;

    setTimeout(() => {
        msgBox.style.display = 'none';
    }, 5000);
}

function showCode() {
    const inputs = document.querySelectorAll('input[type="password"]');
    inputs.forEach(input => {
        if (input.type === 'password') {
            input.type = 'text';
        } else {
            input.type = 'password';
        }
    });

    const btn = event.target;
    if (inputs[0].type === 'text') {
        btn.textContent = 'üîí Code verbergen';
    } else {
        btn.textContent = 'üëÅÔ∏è Code anzeigen';
    }
}

document.getElementById('codeForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const currentCode = document.getElementById('currentCode').value;
    const newCode = document.getElementById('newCode').value;
    const confirmCode = document.getElementById('confirmCode').value;

    // Validierung
    if (newCode !== confirmCode) {
        showMessage('Die neuen Codes stimmen nicht √ºberein!', 'error');
        return;
    }

    if (newCode.length < 4 || newCode.length > 20) {
        showMessage('Der Code muss zwischen 4 und 20 Ziffern lang sein!', 'error');
        return;
    }

    if (!/^\d+$/.test(newCode)) {
        showMessage('Der Code darf nur aus Ziffern bestehen!', 'error');
        return;
    }

    try {
        const response = await fetch('/api/settings/change_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_code: currentCode,
                new_code: newCode
            })
        });

        const result = await response.json();

        if (result.success) {
            showMessage(result.message, 'success');

            // Formular zur√ºcksetzen
            document.getElementById('codeForm').reset();

            // Aktuellen Code aktualisieren (verschwommen)
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error');
    }
});
</script>
{% endblock %}
