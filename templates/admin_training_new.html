{% extends "base.html" %}
{% block title %}Übungsmodus-Verwaltung - VDE Messwand{% endblock %}

{% block content %}
<div class="glass-card">
    <h1>Übungsmodus-Verwaltung</h1>
    <p style="text-align: center; opacity: 0.8; margin-bottom: 30px;">
        Wähle eine Kategorie aus (z.B. RISO, Zi, Zs), dann wähle die Relais, die für alle Trainingsseiten aktiviert werden sollen
    </p>

    <div id="messageBox" class="message"></div>

    <!-- Schritt 1: Kategorie auswählen -->
    <div style="margin-bottom: 30px;">
        <h2 style="color: #ff4444; margin-bottom: 15px;">1. Kategorie auswählen</h2>
        <select id="categorySelect" onchange="loadRelays()" style="width: 100%; padding: 15px; font-size: 1.1em; border-radius: 8px; background: rgba(255, 255, 255, 0.06); color: #fff; border: 1px solid rgba(255, 255, 255, 0.12);">
            <option value="">-- Bitte wählen --</option>
            {% for kat in kategorien %}
            <option value="{{ kat }}">{{ kat }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Schritt 2: Trainingsseiten auswählen -->
    <div id="pageSection" style="display: none; margin-bottom: 30px;">
        <h2 style="color: #ff4444; margin-bottom: 15px;">2. Trainingsseiten auswählen (mehrere möglich)</h2>
        <div id="pageList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
            {% for page in training_pages %}
            <div class="page-checkbox" style="padding: 15px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 10px; cursor: pointer;" onclick="togglePage('{{ page.page_id }}', this)">
                <input type="checkbox" id="page_{{ page.page_id }}" value="{{ page.page_id }}" style="margin-right: 10px;">
                <label for="page_{{ page.page_id }}" style="cursor: pointer; color: #fff;">{{ page.name }}</label>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Schritt 3: Relais auswählen -->
    <div id="relaySection" style="display: none;">
        <h2 style="color: #ff4444; margin-bottom: 15px;">3. Relais auswählen (mehrere möglich)</h2>

        <div id="relayList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="saveMapping()" id="saveBtn">
                Speichern
            </button>
        </div>
    </div>

    <!-- Aktuelle Konfiguration anzeigen -->
    <div id="currentConfig" style="margin-top: 40px; padding: 20px; background: rgba(255, 255, 255, 0.03); border-radius: 15px; display: none;">
        <h3 style="color: #ffc107; margin-bottom: 15px;">Aktuelle Konfiguration</h3>
        <div id="configDisplay"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allRelays = {{ relais_config|tojson }};
    let trainingConfig = {{ training_config|tojson }};
    let selectedRelays = [];
    let selectedPages = [];

    function showMessage(message, type) {
        const msgBox = document.getElementById('messageBox');
        msgBox.textContent = message;
        msgBox.className = type === 'success' ? 'status-success' : 'status-error';
        msgBox.style.display = 'block';
        setTimeout(() => {
            msgBox.style.display = 'none';
        }, 5000);
    }

    function togglePage(pageId, element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
            selectedPages.push(pageId);
            element.style.background = 'rgba(227, 6, 19, 0.12)';
            element.style.borderColor = 'rgba(227, 6, 19, 0.3)';
        } else {
            selectedPages = selectedPages.filter(p => p !== pageId);
            element.style.background = 'rgba(255, 255, 255, 0.03)';
            element.style.borderColor = 'rgba(255, 255, 255, 0.06)';
        }

        updateRelaySection();
    }

    function updateRelaySection() {
        const relaySection = document.getElementById('relaySection');
        relaySection.style.display = selectedPages.length > 0 ? 'block' : 'none';
    }

    function loadRelays() {
        const category = document.getElementById('categorySelect').value;
        const pageSection = document.getElementById('pageSection');
        const relaySection = document.getElementById('relaySection');
        const relayList = document.getElementById('relayList');
        const currentConfig = document.getElementById('currentConfig');

        if (!category) {
            pageSection.style.display = 'none';
            relaySection.style.display = 'none';
            currentConfig.style.display = 'none';
            return;
        }

        pageSection.style.display = 'block';

        selectedPages = [];
        const checkboxes = document.querySelectorAll('.page-checkbox input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = false;
            cb.parentElement.style.background = 'rgba(255, 255, 255, 0.03)';
            cb.parentElement.style.borderColor = 'rgba(255, 255, 255, 0.06)';
        });

        const categoryRelays = [];
        for (const [relayNum, relayData] of Object.entries(allRelays)) {
            if (relayData.category === category) {
                categoryRelays.push({
                    num: parseInt(relayNum),
                    name: relayData.name,
                    stromkreis: relayData.stromkreis
                });
            }
        }

        categoryRelays.sort((a, b) => a.num - b.num);

        selectedRelays = [];
        const firstPage = Object.keys(trainingConfig[category] || {})[0];
        if (firstPage) {
            selectedRelays = [...(trainingConfig[category][firstPage] || [])];
        }

        relayList.innerHTML = '';
        categoryRelays.forEach(relay => {
            const isSelected = selectedRelays.includes(relay.num);
            const card = document.createElement('div');
            card.style.cssText = `
                padding: 15px;
                background: ${isSelected ? 'rgba(227, 6, 19, 0.12)' : 'rgba(255, 255, 255, 0.03)'};
                border: 1px solid ${isSelected ? 'rgba(227, 6, 19, 0.3)' : 'rgba(255, 255, 255, 0.06)'};
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s;
            `;

            card.innerHTML = `
                <div style="font-weight: bold; color: #ff4444; margin-bottom: 5px;">
                    Relais ${relay.num}
                </div>
                <div style="color: rgba(255, 255, 255, 0.9); font-size: 0.9em; margin-bottom: 3px;">
                    ${relay.name}
                </div>
                <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85em;">
                    ${relay.stromkreis}
                </div>
                ${isSelected ? '<div style="color: #4caf50; font-weight: bold; margin-top: 8px;">Ausgewählt</div>' : ''}
            `;

            card.onclick = () => toggleRelay(relay.num, card);
            relayList.appendChild(card);
        });

        displayCurrentConfig();
    }

    function toggleRelay(relayNum, card) {
        const index = selectedRelays.indexOf(relayNum);
        if (index > -1) {
            selectedRelays.splice(index, 1);
            card.style.background = 'rgba(255, 255, 255, 0.03)';
            card.style.borderColor = 'rgba(255, 255, 255, 0.06)';
            card.querySelector('div:last-child').remove();
        } else {
            selectedRelays.push(relayNum);
            card.style.background = 'rgba(227, 6, 19, 0.12)';
            card.style.borderColor = 'rgba(227, 6, 19, 0.3)';
            const checkmark = document.createElement('div');
            checkmark.style.cssText = 'color: #4caf50; font-weight: bold; margin-top: 8px;';
            checkmark.textContent = 'Ausgewählt';
            card.appendChild(checkmark);
        }
        displayCurrentConfig();
    }

    function displayCurrentConfig() {
        const configDisplay = document.getElementById('configDisplay');
        const currentConfig = document.getElementById('currentConfig');

        if (selectedRelays.length === 0) {
            currentConfig.style.display = 'none';
            return;
        }

        currentConfig.style.display = 'block';
        selectedRelays.sort((a, b) => a - b);
        configDisplay.innerHTML = `
            <div style="color: rgba(255, 255, 255, 0.9);">
                <strong>${selectedRelays.length} Relais ausgewählt:</strong><br>
                ${selectedRelays.join(', ')}
            </div>
        `;
    }

    async function saveMapping() {
        const category = document.getElementById('categorySelect').value;

        if (!category) {
            showMessage('Bitte Kategorie auswählen', 'error');
            return;
        }

        if (selectedPages.length === 0) {
            showMessage('Bitte mindestens eine Trainingsseite auswählen', 'error');
            return;
        }

        if (selectedRelays.length === 0) {
            showMessage('Bitte mindestens ein Relais auswählen', 'error');
            return;
        }

        try {
            let successCount = 0;
            for (const pageId of selectedPages) {
                const response = await fetch('/api/training/configure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_id: pageId,
                        category: category,
                        relay_numbers: selectedRelays
                    })
                });

                const result = await response.json();
                if (result.success) {
                    successCount++;
                    if (!trainingConfig[category]) {
                        trainingConfig[category] = {};
                    }
                    trainingConfig[category][pageId] = selectedRelays;
                }
            }

            if (successCount === selectedPages.length) {
                showMessage(`Konfiguration für ${successCount} Seite(n) gespeichert!`, 'success');
            } else {
                showMessage(`Nur ${successCount} von ${selectedPages.length} Seiten gespeichert`, 'error');
            }
        } catch (error) {
            showMessage('Netzwerkfehler: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
